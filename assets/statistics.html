<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆçµ±è¨ˆ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background-color: #4CAF50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        .stat-card {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid #4CAF50;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 8px;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .history-section {
            padding: 20px;
        }
        .history-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        .history-item:hover {
            background-color: #f8f9fa;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .file-name {
            font-weight: 500;
            color: #333;
        }
        .timestamp {
            font-size: 12px;
            color: #666;
        }
        .buttons {
            padding: 20px;
            text-align: center;
            background-color: #f8f9fa;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .no-data {
            text-align: center;
            color: #666;
            padding: 40px;
            font-style: italic;
        }
        .daily-stats {
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 6px;
            margin-top: 20px;
        }
        .daily-stats h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .daily-stats p {
            margin: 5px 0;
            color: #555;
        }
        
        /* æ–°ã—ã„ã‚¹ã‚¿ã‚¤ãƒ« */
        .date-selector {
            padding: 20px;
            background-color: #f8f9fa;
            border-bottom: 2px solid #eee;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .date-selector label {
            font-weight: 600;
            color: #333;
        }
        
        .date-selector input, .date-selector select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .sessions-section {
            padding: 20px;
        }
        
        .sessions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .sessions-table th, .sessions-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .sessions-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }
        
        .sessions-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .category-tag {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            color: white;
            text-transform: uppercase;
        }
        
        .category-browser {
            background-color: #2196F3;
        }
        
        .category-development {
            background-color: #9C27B0;
        }
        
        .category-application {
            background-color: #4CAF50;
        }
        
        .category-game {
            background-color: #FF9800;
        }
        
        .category-default {
            background-color: #757575;
        }
        
        .session-time {
            font-family: monospace;
            font-size: 13px;
            color: #666;
        }
        
        .app-clickable {
            cursor: pointer;
            color: #4CAF50;
            text-decoration: underline;
        }
        
        .app-clickable:hover {
            color: #45a049;
        }
        
        .sessions-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .summary-item {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .summary-number {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .summary-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
        .filter-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .filter-btn.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .back-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        .back-btn:hover {
            background-color: #5a6268;
        }
        
        .window-title {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .duration-badge {
            background-color: #e9ecef;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆçµ±è¨ˆ</h1>
        </div>
        
        <div class="date-selector">
            <label for="dateSelect">ğŸ“… æ—¥ä»˜é¸æŠ:</label>
            <input type="date" id="dateSelect" />
            <select id="quickDateSelect">
                <option value="">æ—¥ä»˜ã‚’é¸æŠ...</option>
                <option value="today">ä»Šæ—¥</option>
                <option value="yesterday">æ˜¨æ—¥</option>
                <option value="week">éå»7æ—¥é–“</option>
            </select>
            <button class="btn" onclick="loadSelectedDate()">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º</button>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">ç·æ’®å½±æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayCount">0</div>
                <div class="stat-label">ä»Šæ—¥ã®æ’®å½±æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="status">åœæ­¢ä¸­</div>
                <div class="stat-label">ç¾åœ¨ã®çŠ¶æ…‹</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="lastCapture">-</div>
                <div class="stat-label">æœ€æ–°æ’®å½±æ™‚åˆ»</div>
            </div>
        </div>

        <div class="sessions-section">
            <div class="history-title">ğŸ“Š é¸æŠã—ãŸæ—¥ä»˜ã®è©³ç´°çµ±è¨ˆ</div>
            <div id="selectedDateSummary">
                <p style="color: #666; font-style: italic;">æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
            </div>
            
            <div id="sessionsDetailContainer" style="display: none;">
                <div class="filter-section">
                    <label>ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
                    <div class="filter-buttons" id="filterButtons"></div>
                </div>
                
                <button id="backToOverview" class="back-btn" style="display: none;" onclick="showOverview()">â† æ¦‚è¦ã«æˆ»ã‚‹</button>
                
                <div class="sessions-container">
                    <table class="sessions-table" id="sessionsTable">
                        <thead>
                            <tr>
                                <th>æ™‚åˆ»</th>
                                <th>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³</th>
                                <th>ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</th>
                                <th>ã‚«ãƒ†ã‚´ãƒª</th>
                                <th>ä½¿ç”¨æ™‚é–“</th>
                                <th>ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚¿ã‚¤ãƒˆãƒ«</th>
                            </tr>
                        </thead>
                        <tbody id="sessionsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="daily-stats">
            <h3>ğŸ“ˆ ä½¿ç”¨æ™‚é–“çµ±è¨ˆ</h3>
            <div id="dailyTimeList">
                <p style="color: #666; font-style: italic;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>

        <div class="history-section">
            <div class="history-title">ğŸ“‹ æ’®å½±å±¥æ­´</div>
            <div class="history-list" id="historyList">
                <div class="no-data">ã¾ã ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãŒæ’®å½±ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
            </div>
        </div>

        <!-- CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="csv-export-section" style="padding: 20px; background-color: #f8f9fa; border-top: 2px solid #eee;">
            <div class="history-title">ğŸ“Š CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: center; margin: 15px 0;">
                <div>
                    <label for="exportStartDate">é–‹å§‹æ—¥:</label>
                    <input type="date" id="exportStartDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"/>
                </div>
                <div>
                    <label for="exportEndDate">çµ‚äº†æ—¥:</label>
                    <input type="date" id="exportEndDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"/>
                </div>
                <button class="btn" onclick="exportToCSV()" id="exportButton" style="padding: 10px 20px;">
                    ğŸ“‹ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                </button>
            </div>
            <div id="exportProgress" style="display: none; margin-top: 10px; padding: 10px; background-color: #e3f2fd; border-radius: 4px; text-align: center;">
                <div style="margin-bottom: 5px;">ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­...</div>
                <div style="width: 100%; background-color: #ddd; border-radius: 10px;">
                    <div id="progressBar" style="width: 0%; height: 20px; background-color: #4CAF50; border-radius: 10px; transition: width 0.3s;"></div>
                </div>
            </div>
            <div id="exportResult" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;"></div>
            <div style="margin-top: 10px; font-size: 12px; color: #666;">
                ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã«ã¯ã€é¸æŠã—ãŸæœŸé–“å†…ã®å…¨ã¦ã®ä½¿ç”¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä½¿ç”¨æ™‚é–“ã€ã‚«ãƒ†ã‚´ãƒªæƒ…å ±ãŒå«ã¾ã‚Œã¾ã™ã€‚
            </div>
        </div>

        <div class="buttons">
            <button class="btn" onclick="refreshStats()">ğŸ”„ æ›´æ–°</button>
            <button class="btn btn-secondary" onclick="openSaveFolder()">ğŸ“ ä¿å­˜ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã</button>
            <button class="btn btn-secondary" onclick="closeWindow()">âŒ é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        let currentView = 'overview'; // 'overview' or 'application'
        let currentDate = null;
        let currentApplication = null;
        let allSessions = [];

        function refreshStats() {
            ipcRenderer.send('request-statistics');
        }

        function openSaveFolder() {
            ipcRenderer.send('open-save-folder');
        }

        function closeWindow() {
            window.close();
        }

        function formatTime(date) {
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        function formatTimeShort(date) {
            return date.toLocaleString('ja-JP', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatDuration(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours}æ™‚é–“${minutes % 60}åˆ†`;
            } else if (minutes > 0) {
                return `${minutes}åˆ†${seconds % 60}ç§’`;
            } else {
                return `${seconds}ç§’`;
            }
        }

        function updateStatistics(data) {
            document.getElementById('totalCount').textContent = data.totalCount;
            document.getElementById('todayCount').textContent = data.todayCount;
            document.getElementById('status').textContent = data.isCapturing ? 'å®Ÿè¡Œä¸­' : 'åœæ­¢ä¸­';
            
            const lastCaptureElement = document.getElementById('lastCapture');
            if (data.lastCapture) {
                lastCaptureElement.textContent = formatTime(new Date(data.lastCapture));
            } else {
                lastCaptureElement.textContent = '-';
            }

            const historyList = document.getElementById('historyList');
            
            if (data.history && data.history.length > 0) {
                historyList.innerHTML = data.history.map(item => {
                    const fileName = item.filePath.split('\\').pop() || item.filePath.split('/').pop();
                    return `
                        <div class="history-item">
                            <div class="file-name">${fileName}</div>
                            <div class="timestamp">${formatTime(new Date(item.timestamp))}</div>
                        </div>
                    `;
                }).join('');
            } else {
                historyList.innerHTML = '<div class="no-data">ã¾ã ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãŒæ’®å½±ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
            }
        }

        // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡
        ipcRenderer.on('statistics-data', (event, data) => {
            updateStatistics(data);

            // å®Ÿéš›ã®ä½¿ç”¨æ™‚é–“ãƒ‡ãƒ¼ã‚¿ã‚’å„ªå…ˆè¡¨ç¤º
            const dailyList = document.getElementById('dailyTimeList');
            dailyList.innerHTML = '';
            
            // ã‚¨ãƒ©ãƒ¼æƒ…å ±ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
            if (data.error) {
                dailyList.innerHTML = `<p style="color: red; font-style: italic;">âš ï¸ ${data.error}</p>`;
            }
            
            // å®Ÿéš›ã®ä½¿ç”¨æ™‚é–“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
            if (data.realUsageStats && data.realUsageStats.length > 0) {
                const usageDiv = document.createElement('div');
                usageDiv.innerHTML = '<h4>ä»Šæ—¥ã®ä½¿ç”¨æ™‚é–“ (å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿)</h4>';
                data.realUsageStats.forEach(usage => {
                    const categoryColor = getCategoryColor(usage.category);
                    usageDiv.innerHTML += `
                        <div style="margin: 8px 0; padding: 8px; background-color: ${categoryColor}; border-radius: 4px;">
                            <strong>${usage.application}</strong> - ${usage.content}<br>
                            <small>ã‚«ãƒ†ã‚´ãƒª: ${usage.category} | ä½¿ç”¨æ™‚é–“: ${usage.totalDuration}åˆ† | ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: ${usage.sessionCount}</small>
                        </div>
                    `;
                });
                dailyList.appendChild(usageDiv);
            }
            
            // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚‚è¡¨ç¤ºï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
            if (data.dailyStats && Object.keys(data.dailyStats).length > 0) {
                const screenshotDiv = document.createElement('div');
                screenshotDiv.innerHTML = '<h4 style="margin-top: 20px;">æ—¥åˆ¥ç”»é¢æ™‚é–“ (ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆé–“éš”ãƒ™ãƒ¼ã‚¹)</h4>';
                Object.entries(data.dailyStats).forEach(([date, screens]) => {
                    const dateDiv = document.createElement('div');
                    dateDiv.innerHTML = `<h5>${date}</h5>`;
                    Object.entries(screens).forEach(([screen, minutes]) => {
                        dateDiv.innerHTML += `<p style="margin-left: 20px;">${screen}: ${Math.round(minutes)} åˆ†</p>`;
                    });
                    screenshotDiv.appendChild(dateDiv);
                });
                dailyList.appendChild(screenshotDiv);
            }
            
            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
            if (dailyList.innerHTML === '') {
                dailyList.innerHTML = '<p style="color: #666; font-style: italic;">ä½¿ç”¨æ™‚é–“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿ãŒé›†ã¾ã‚Šã¾ã™ã€‚</p>';
            }
        });
        
        function getCategoryColor(category) {
            const colors = {
                'Browser': '#e3f2fd',
                'Development': '#f3e5f5',
                'Application': '#e8f5e8',
                'Game': '#fff3e0',
                'default': '#f5f5f5'
            };
            return colors[category] || colors.default;
        }
        
        // æŒ‡å®šã—ãŸDateã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®YYYY-MM-DDå½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatLocalDate(date) {
            return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2,'0') + '-' + String(date.getDate()).padStart(2,'0');
        }

        function getCategoryClass(category) {
            const classes = {
                'Browser': 'category-browser',
                'Development': 'category-development',
                'Application': 'category-application',
                'Game': 'category-game',
                'default': 'category-default'
            };
            return classes[category] || classes.default;
        }

        // æ—¥ä»˜é¸æŠæ©Ÿèƒ½
        async function loadSelectedDate() {
            const dateInput = document.getElementById('dateSelect');
            const quickSelect = document.getElementById('quickDateSelect');
            
            let selectedDate;
            
            if (quickSelect.value) {
                const today = new Date();
                switch (quickSelect.value) {
                    case 'today':
                        selectedDate = today;
                        break;
                    case 'yesterday':
                        selectedDate = new Date(today);
                        selectedDate.setDate(selectedDate.getDate() - 1);
                        break;
                    case 'week':
                        // éå»7æ—¥é–“ã¯åˆ¥ã®å‡¦ç†ãŒå¿…è¦
                        alert('éå»7æ—¥é–“è¡¨ç¤ºã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™');
                        return;
                }
                                dateInput.value = formatLocalDate(selectedDate);
            } else if (dateInput.value) {
                selectedDate = new Date(dateInput.value);
            } else {
                alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
                        currentDate = formatLocalDate(selectedDate);
            await loadDateSessions(currentDate);
        }
        
        async function loadDateSessions(dateStr) {
            try {
                const [sessions, dailyUsage, summary] = await Promise.all([
                    ipcRenderer.invoke('get-date-sessions', dateStr),
                    ipcRenderer.invoke('get-daily-usage', dateStr),
                    ipcRenderer.invoke('get-date-summary', dateStr)
                ]);
                
                allSessions = sessions;
                displayDateSummary(summary, dailyUsage);
                showOverview();
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('selectedDateSummary').innerHTML = 
                    '<p style="color: red;">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
        }
        
        function displayDateSummary(summary, dailyUsage) {
            const summaryContainer = document.getElementById('selectedDateSummary');
            
            if (!summary || summary.sessionCount === 0) {
                summaryContainer.innerHTML = '<p style="color: #666;">é¸æŠã—ãŸæ—¥ä»˜ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                document.getElementById('sessionsDetailContainer').style.display = 'none';
                return;
            }
            
            summaryContainer.innerHTML = `
                <div class="summary-stats">
                    <div class="summary-item">
                        <div class="summary-number">${summary.sessionCount}</div>
                        <div class="summary-label">ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number">${summary.totalDuration}åˆ†</div>
                        <div class="summary-label">ç·ä½¿ç”¨æ™‚é–“</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number">${summary.applicationCount}</div>
                        <div class="summary-label">ã‚¢ãƒ—ãƒªæ•°</div>
                    </div>
                </div>
                
                <h4>ä½¿ç”¨æ™‚é–“ã®å¤šã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³</h4>
                <div>
                    ${dailyUsage.map(usage => `
                        <div style="margin: 8px 0; padding: 12px; background-color: ${getCategoryColor(usage.category)}; border-radius: 6px; cursor: pointer;" 
                             onclick="showApplicationSessions('${usage.application}')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong class="app-clickable">${usage.application}</strong> - ${usage.content}
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                        <span class="category-tag ${getCategoryClass(usage.category)}">${usage.category}</span>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: #4CAF50;">${usage.totalDuration}åˆ†</div>
                                    <div style="font-size: 12px; color: #666;">${usage.sessionCount}ã‚»ãƒƒã‚·ãƒ§ãƒ³</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('sessionsDetailContainer').style.display = 'block';
            setupFilters();
        }
        
        function setupFilters() {
            const categories = [...new Set(allSessions.map(s => s.category))];
            const applications = [...new Set(allSessions.map(s => s.application))];
            
            const filterContainer = document.getElementById('filterButtons');
            filterContainer.innerHTML = `
                <button class="filter-btn active" onclick="filterSessions('all')">ã™ã¹ã¦</button>
                ${categories.map(cat => 
                    `<button class="filter-btn" onclick="filterSessions('category', '${cat}')">${cat}</button>`
                ).join('')}
            `;
        }
        
        function filterSessions(type, value) {
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            let filteredSessions = allSessions;
            
            if (type === 'category') {
                filteredSessions = allSessions.filter(s => s.category === value);
            }
            
            displaySessionsTable(filteredSessions);
        }
        
        function displaySessionsTable(sessions) {
            const tbody = document.getElementById('sessionsTableBody');
            
            if (sessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }
            
            tbody.innerHTML = sessions.map(session => `
                <tr>
                    <td class="session-time">
                        ${formatTimeShort(new Date(session.startTime))} - ${formatTimeShort(new Date(session.endTime))}
                    </td>
                    <td>
                        <span class="app-clickable" onclick="showApplicationSessions('${session.application}')">
                            ${session.application}
                        </span>
                    </td>
                    <td>${session.content}</td>
                    <td>
                        <span class="category-tag ${getCategoryClass(session.category)}">${session.category}</span>
                    </td>
                    <td>
                        <span class="duration-badge">${formatDuration(session.duration)}</span>
                    </td>
                    <td class="window-title" title="${session.windowTitle}">${session.windowTitle}</td>
                </tr>
            `).join('');
        }
        
        async function showApplicationSessions(application) {
            try {
                const appSessions = await ipcRenderer.invoke('get-application-sessions', currentDate, application);
                currentApplication = application;
                currentView = 'application';
                
                displaySessionsTable(appSessions);
                document.getElementById('backToOverview').style.display = 'block';
                
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’éè¡¨ç¤º
                document.querySelector('.filter-section').style.display = 'none';
                
            } catch (error) {
                console.error('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆ¥ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        function showOverview() {
            currentView = 'overview';
            currentApplication = null;
            
            displaySessionsTable(allSessions);
            document.getElementById('backToOverview').style.display = 'none';
            document.querySelector('.filter-section').style.display = 'block';
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            setupFilters();
        }

        // åˆæœŸåŒ–
        async function initializePage() {
            try {
                const availableDates = await ipcRenderer.invoke('get-available-dates');
                const quickSelect = document.getElementById('quickDateSelect');
                
                // åˆ©ç”¨å¯èƒ½ãªæ—¥ä»˜ã‚’ã‚¯ã‚¤ãƒƒã‚¯é¸æŠã«è¿½åŠ 
                if (availableDates.length > 0) {
                    availableDates.slice(0, 10).forEach(date => {
                        const option = document.createElement('option');
                        option.value = date;
                        option.textContent = new Date(date).toLocaleDateString('ja-JP');
                        quickSelect.appendChild(option);
                    });
                }
                
                // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
                const today = formatLocalDate(new Date());
                document.getElementById('dateSelect').value = today;
                
            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
            
            refreshStats();
        }

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        async function exportToCSV() {
            const startDateInput = document.getElementById('exportStartDate');
            const endDateInput = document.getElementById('exportEndDate');
            const exportButton = document.getElementById('exportButton');
            const progressDiv = document.getElementById('exportProgress');
            const progressBar = document.getElementById('progressBar');
            const resultDiv = document.getElementById('exportResult');

            // å…¥åŠ›å€¤æ¤œè¨¼
            if (!startDateInput.value || !endDateInput.value) {
                showExportResult('ã‚¨ãƒ©ãƒ¼: é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);

            if (startDate > endDate) {
                showExportResult('ã‚¨ãƒ©ãƒ¼: é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                // UIçŠ¶æ…‹ã‚’æ›´æ–°
                exportButton.disabled = true;
                exportButton.textContent = 'å‡¦ç†ä¸­...';
                progressDiv.style.display = 'block';
                resultDiv.style.display = 'none';

                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’é€²è¡Œ
                updateProgress(25);

                // CSVãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const csvResult = await ipcRenderer.invoke('export-csv', startDateInput.value, endDateInput.value);
                updateProgress(75);

                if (!csvResult.success) {
                    throw new Error(csvResult.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }

                // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
                const fileName = `usage-statistics-${startDateInput.value}-to-${endDateInput.value}.csv`;
                const saveResult = await ipcRenderer.invoke('save-csv-file', csvResult.data, fileName);
                updateProgress(100);

                if (saveResult.success) {
                    if (saveResult.canceled) {
                        showExportResult('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ', 'info');
                    } else {
                        showExportResult(`CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ: ${saveResult.filePath}`, 'success');
                    }
                } else {
                    throw new Error(saveResult.error || 'ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

            } catch (error) {
                console.error('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showExportResult(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                // UIçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                exportButton.disabled = false;
                exportButton.textContent = 'ğŸ“‹ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ';
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 2000);
            }
        }

        function updateProgress(percentage) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
        }

        function showExportResult(message, type) {
            const resultDiv = document.getElementById('exportResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = message;
            
            // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
            resultDiv.className = '';
            if (type === 'success') {
                resultDiv.style.backgroundColor = '#d4edda';
                resultDiv.style.borderColor = '#c3e6cb';
                resultDiv.style.color = '#155724';
            } else if (type === 'error') {
                resultDiv.style.backgroundColor = '#f8d7da';
                resultDiv.style.borderColor = '#f5c6cb';
                resultDiv.style.color = '#721c24';
            } else if (type === 'info') {
                resultDiv.style.backgroundColor = '#d1ecf1';
                resultDiv.style.borderColor = '#bee5eb';
                resultDiv.style.color = '#0c5460';
            }
        }

        // åˆæœŸåŒ–æ™‚ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ—¥ä»˜ã‚’è¨­å®š
        function initializeExportDates() {
            const today = formatLocalDate(new Date());
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const weekAgoStr = formatLocalDate(oneWeekAgo);

            document.getElementById('exportStartDate').value = weekAgoStr;
            document.getElementById('exportEndDate').value = today;
        }

        // åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        window.addEventListener('DOMContentLoaded', () => {
            initializePage();
            initializeExportDates();
        });
    </script>
</body>
</html>