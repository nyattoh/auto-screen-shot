<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÁµ±Ë®à</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background-color: #4CAF50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        .stat-card {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid #4CAF50;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 8px;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .history-section {
            padding: 20px;
        }
        .history-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        .history-item:hover {
            background-color: #f8f9fa;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .file-name {
            font-weight: 500;
            color: #333;
        }
        .timestamp {
            font-size: 12px;
            color: #666;
        }
        .buttons {
            padding: 20px;
            text-align: center;
            background-color: #f8f9fa;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .no-data {
            text-align: center;
            color: #666;
            padding: 40px;
            font-style: italic;
        }
        .daily-stats {
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 6px;
            margin-top: 20px;
        }
        .daily-stats h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .daily-stats p {
            margin: 5px 0;
            color: #555;
        }
        
        /* Êñ∞„Åó„ÅÑ„Çπ„Çø„Ç§„É´ */
        .date-selector {
            padding: 20px;
            background-color: #f8f9fa;
            border-bottom: 2px solid #eee;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .date-selector label {
            font-weight: 600;
            color: #333;
        }
        
        .date-selector input, .date-selector select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .sessions-section {
            padding: 20px;
        }
        
        .sessions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .sessions-table th, .sessions-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .sessions-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }
        
        .sessions-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .category-tag {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            color: white;
            text-transform: uppercase;
        }
        
        .category-browser {
            background-color: #2196F3;
        }
        
        .category-development {
            background-color: #9C27B0;
        }
        
        .category-application {
            background-color: #4CAF50;
        }
        
        .category-game {
            background-color: #FF9800;
        }
        
        .category-default {
            background-color: #757575;
        }
        
        .session-time {
            font-family: monospace;
            font-size: 13px;
            color: #666;
        }
        
        .app-clickable {
            cursor: pointer;
            color: #4CAF50;
            text-decoration: underline;
        }
        
        .app-clickable:hover {
            color: #45a049;
        }
        
        .sessions-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .summary-item {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .summary-number {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .summary-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
        .filter-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .filter-btn.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .back-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        .back-btn:hover {
            background-color: #5a6268;
        }
        
        .window-title {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .duration-badge {
            background-color: #e9ecef;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÁµ±Ë®à</h1>
        </div>
        
        <div class="date-selector">
            <label for="dateSelect">üìÖ Êó•‰ªòÈÅ∏Êäû:</label>
            <input type="date" id="dateSelect" />
            <select id="quickDateSelect">
                <option value="">Êó•‰ªò„ÇíÈÅ∏Êäû...</option>
                <option value="today">‰ªäÊó•</option>
                <option value="yesterday">Êò®Êó•</option>
                <option value="week">ÈÅéÂéª7Êó•Èñì</option>
            </select>
            <button class="btn" onclick="loadSelectedDate()">üìä „Éá„Éº„Çø„ÇíË°®Á§∫</button>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">Á∑èÊíÆÂΩ±Êï∞</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayCount">0</div>
                <div class="stat-label">‰ªäÊó•„ÅÆÊíÆÂΩ±Êï∞</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="status">ÂÅúÊ≠¢‰∏≠</div>
                <div class="stat-label">ÁèæÂú®„ÅÆÁä∂ÊÖã</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="lastCapture">-</div>
                <div class="stat-label">ÊúÄÊñ∞ÊíÆÂΩ±ÊôÇÂàª</div>
            </div>
        </div>

        <div class="sessions-section">
            <div class="history-title">üìä ÈÅ∏Êäû„Åó„ÅüÊó•‰ªò„ÅÆË©≥Á¥∞Áµ±Ë®à</div>
            <div id="selectedDateSummary">
                <p style="color: #666; font-style: italic;">Êó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            </div>
            
            <div id="sessionsDetailContainer" style="display: none;">
                <div class="filter-section">
                    <label>üîç „Éï„Ç£„É´„Çø„Éº:</label>
                    <div class="filter-buttons" id="filterButtons"></div>
                </div>
                
                <button id="backToOverview" class="back-btn" style="display: none;" onclick="showOverview()">‚Üê Ê¶ÇË¶Å„Å´Êàª„Çã</button>
                
                <div class="sessions-container">
                    <table class="sessions-table" id="sessionsTable">
                        <thead>
                            <tr>
                                <th>ÊôÇÂàª</th>
                                <th>„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥</th>
                                <th>„Ç≥„É≥„ÉÜ„É≥„ÉÑ</th>
                                <th>„Ç´„ÉÜ„Ç¥„É™</th>
                                <th>‰ΩøÁî®ÊôÇÈñì</th>
                                <th>„Ç¶„Ç£„É≥„Éâ„Ç¶„Çø„Ç§„Éà„É´</th>
                            </tr>
                        </thead>
                        <tbody id="sessionsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="daily-stats">
            <h3>üìà ‰ΩøÁî®ÊôÇÈñìÁµ±Ë®à</h3>
            <div id="dailyTimeList">
                <p style="color: #666; font-style: italic;">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
            </div>
        </div>

        <div class="history-section">
            <div class="history-title">üìã ÊíÆÂΩ±Â±•Ê≠¥</div>
            <div class="history-list" id="historyList">
                <div class="no-data">„Åæ„Å†„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà„ÅåÊíÆÂΩ±„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>
            </div>
        </div>

        <!-- CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Çª„ÇØ„Ç∑„Éß„É≥ -->
        <div class="csv-export-section" style="padding: 20px; background-color: #f8f9fa; border-top: 2px solid #eee;">
            <div class="history-title">üìä CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: center; margin: 15px 0;">
                <div>
                    <label for="exportStartDate">ÈñãÂßãÊó•:</label>
                    <input type="date" id="exportStartDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"/>
                </div>
                <div>
                    <label for="exportEndDate">ÁµÇ‰∫ÜÊó•:</label>
                    <input type="date" id="exportEndDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"/>
                </div>
                <button class="btn" onclick="exportToCSV()" id="exportButton" style="padding: 10px 20px;">
                    üìã CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                </button>
            </div>
            <div id="exportProgress" style="display: none; margin-top: 10px; padding: 10px; background-color: #e3f2fd; border-radius: 4px; text-align: center;">
                <div style="margin-bottom: 5px;">„Éá„Éº„Çø„ÇíÂá¶ÁêÜ‰∏≠...</div>
                <div style="width: 100%; background-color: #ddd; border-radius: 10px;">
                    <div id="progressBar" style="width: 0%; height: 20px; background-color: #4CAF50; border-radius: 10px; transition: width 0.3s;"></div>
                </div>
            </div>
            <div id="exportResult" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;"></div>
            <div style="margin-top: 10px; font-size: 12px; color: #666;">
                üí° „Éí„É≥„Éà: „Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åï„Çå„Çã„Éá„Éº„Çø„Å´„ÅØ„ÄÅÈÅ∏Êäû„Åó„ÅüÊúüÈñìÂÜÖ„ÅÆÂÖ®„Å¶„ÅÆ‰ΩøÁî®„Çª„ÉÉ„Ç∑„Éß„É≥„ÄÅ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥‰ΩøÁî®ÊôÇÈñì„ÄÅ„Ç´„ÉÜ„Ç¥„É™ÊÉÖÂ†±„ÅåÂê´„Åæ„Çå„Åæ„Åô„ÄÇ
            </div>
        </div>

        <div class="buttons">
            <button class="btn" onclick="refreshStats()">üîÑ Êõ¥Êñ∞</button>
            <button class="btn btn-secondary" onclick="openSaveFolder()">üìÅ ‰øùÂ≠ò„Éï„Ç©„É´„ÉÄ„ÇíÈñã„Åè</button>
            <button class="btn btn-secondary" onclick="closeWindow()">‚ùå Èñâ„Åò„Çã</button>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        let currentView = 'overview'; // 'overview' or 'application'
        let currentDate = null;
        let currentApplication = null;
        let allSessions = [];

        function refreshStats() {
            ipcRenderer.send('request-statistics');
        }

        function openSaveFolder() {
            ipcRenderer.send('open-save-folder');
        }

        function closeWindow() {
            window.close();
        }

        function formatTime(date) {
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        function formatTimeShort(date) {
            return date.toLocaleString('ja-JP', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatDuration(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours}ÊôÇÈñì${minutes % 60}ÂàÜ`;
            } else if (minutes > 0) {
                return `${minutes}ÂàÜ${seconds % 60}Áßí`;
            } else {
                return `${seconds}Áßí`;
            }
        }

        function updateStatistics(data) {
            document.getElementById('totalCount').textContent = data.totalCount;
            document.getElementById('todayCount').textContent = data.todayCount;
            document.getElementById('status').textContent = data.isCapturing ? 'ÂÆüË°å‰∏≠' : 'ÂÅúÊ≠¢‰∏≠';
            
            const lastCaptureElement = document.getElementById('lastCapture');
            if (data.lastCapture) {
                lastCaptureElement.textContent = formatTime(new Date(data.lastCapture));
            } else {
                lastCaptureElement.textContent = '-';
            }

            const historyList = document.getElementById('historyList');
            
            if (data.history && data.history.length > 0) {
                historyList.innerHTML = data.history.map(item => {
                    const fileName = item.filePath.split('\\').pop() || item.filePath.split('/').pop();
                    return `
                        <div class="history-item">
                            <div class="file-name">${fileName}</div>
                            <div class="timestamp">${formatTime(new Date(item.timestamp))}</div>
                        </div>
                    `;
                }).join('');
            } else {
                historyList.innerHTML = '<div class="no-data">„Åæ„Å†„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà„ÅåÊíÆÂΩ±„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>';
            }
        }

        // Áµ±Ë®à„Éá„Éº„Çø„ÇíÂèó‰ø°
        ipcRenderer.on('statistics-data', (event, data) => {
            updateStatistics(data);

            // ÂÆüÈöõ„ÅÆ‰ΩøÁî®ÊôÇÈñì„Éá„Éº„Çø„ÇíÂÑ™ÂÖàË°®Á§∫
            const dailyList = document.getElementById('dailyTimeList');
            dailyList.innerHTML = '';
            
            // „Ç®„É©„ÉºÊÉÖÂ†±„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË°®Á§∫
            if (data.error) {
                dailyList.innerHTML = `<p style="color: red; font-style: italic;">‚ö†Ô∏è ${data.error}</p>`;
            }
            
            // ÂÆüÈöõ„ÅÆ‰ΩøÁî®ÊôÇÈñì„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà
            if (data.realUsageStats && data.realUsageStats.length > 0) {
                const usageDiv = document.createElement('div');
                usageDiv.innerHTML = '<h4>‰ªäÊó•„ÅÆ‰ΩøÁî®ÊôÇÈñì (ÂÆüÈöõ„ÅÆ„Éá„Éº„Çø)</h4>';
                data.realUsageStats.forEach(usage => {
                    const categoryColor = getCategoryColor(usage.category);
                    usageDiv.innerHTML += `
                        <div style="margin: 8px 0; padding: 8px; background-color: ${categoryColor}; border-radius: 4px;">
                            <strong>${usage.application}</strong> - ${usage.content}<br>
                            <small>„Ç´„ÉÜ„Ç¥„É™: ${usage.category} | ‰ΩøÁî®ÊôÇÈñì: ${usage.totalDuration}ÂàÜ | „Çª„ÉÉ„Ç∑„Éß„É≥Êï∞: ${usage.sessionCount}</small>
                        </div>
                    `;
                });
                dailyList.appendChild(usageDiv);
            }
            
            // „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà„Éô„Éº„Çπ„ÅÆ„Éá„Éº„Çø„ÇÇË°®Á§∫ÔºàÂæåÊñπ‰∫íÊèõÊÄßÔºâ
            if (data.dailyStats && Object.keys(data.dailyStats).length > 0) {
                const screenshotDiv = document.createElement('div');
                screenshotDiv.innerHTML = '<h4 style="margin-top: 20px;">Êó•Âà•ÁîªÈù¢ÊôÇÈñì („Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÈñìÈöî„Éô„Éº„Çπ)</h4>';
                Object.entries(data.dailyStats).forEach(([date, screens]) => {
                    const dateDiv = document.createElement('div');
                    dateDiv.innerHTML = `<h5>${date}</h5>`;
                    Object.entries(screens).forEach(([screen, minutes]) => {
                        dateDiv.innerHTML += `<p style="margin-left: 20px;">${screen}: ${Math.round(minutes)} ÂàÜ</p>`;
                    });
                    screenshotDiv.appendChild(dateDiv);
                });
                dailyList.appendChild(screenshotDiv);
            }
            
            // „Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà
            if (dailyList.innerHTML === '') {
                dailyList.innerHTML = '<p style="color: #666; font-style: italic;">‰ΩøÁî®ÊôÇÈñì„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Çí‰ΩøÁî®„Åó„Å¶„ÅÑ„Çã„Å®„Éá„Éº„Çø„ÅåÈõÜ„Åæ„Çä„Åæ„Åô„ÄÇ</p>';
            }
        });
        
        function getCategoryColor(category) {
            const colors = {
                'Browser': '#e3f2fd',
                'Development': '#f3e5f5',
                'Application': '#e8f5e8',
                'Game': '#fff3e0',
                'default': '#f5f5f5'
            };
            return colors[category] || colors.default;
        }
        
        // ÊåáÂÆö„Åó„ÅüDate„Çí„É≠„Éº„Ç´„É´„Çø„Ç§„É†„Çæ„Éº„É≥„ÅÆYYYY-MM-DDÂΩ¢Âºè„Å´„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatLocalDate(date) {
            return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2,'0') + '-' + String(date.getDate()).padStart(2,'0');
        }

        function getCategoryClass(category) {
            const classes = {
                'Browser': 'category-browser',
                'Development': 'category-development',
                'Application': 'category-application',
                'Game': 'category-game',
                'default': 'category-default'
            };
            return classes[category] || classes.default;
        }

        // Êó•‰ªòÈÅ∏ÊäûÊ©üËÉΩ
        async function loadSelectedDate() {
            const dateInput = document.getElementById('dateSelect');
            const quickSelect = document.getElementById('quickDateSelect');
            
            let selectedDate;
            
            if (quickSelect.value) {
                const today = new Date();
                switch (quickSelect.value) {
                    case 'today':
                        selectedDate = today;
                        break;
                    case 'yesterday':
                        selectedDate = new Date(today);
                        selectedDate.setDate(selectedDate.getDate() - 1);
                        break;
                    case 'week':
                        // ÈÅéÂéª7Êó•Èñì„ÅØÂà•„ÅÆÂá¶ÁêÜ„ÅåÂøÖË¶Å
                        alert('ÈÅéÂéª7Êó•ÈñìË°®Á§∫„ÅØ‰ªäÂæåÂÆüË£Ö‰∫àÂÆö„Åß„Åô');
                        return;
                }
                                dateInput.value = formatLocalDate(selectedDate);
            } else if (dateInput.value) {
                selectedDate = new Date(dateInput.value);
            } else {
                alert('Êó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
                        currentDate = formatLocalDate(selectedDate);
            await loadDateSessions(currentDate);
        }
        
        async function loadDateSessions(dateStr) {
            try {
                const [sessions, dailyUsage, summary] = await Promise.all([
                    ipcRenderer.invoke('get-date-sessions', dateStr),
                    ipcRenderer.invoke('get-daily-usage', dateStr),
                    ipcRenderer.invoke('get-date-summary', dateStr)
                ]);
                
                allSessions = sessions;
                displayDateSummary(summary, dailyUsage);
                showOverview();
                
            } catch (error) {
                console.error('„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:', error);
                document.getElementById('selectedDateSummary').innerHTML = 
                    '<p style="color: red;">„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>';
            }
        }
        
        function displayDateSummary(summary, dailyUsage) {
            const summaryContainer = document.getElementById('selectedDateSummary');
            
            if (!summary || summary.sessionCount === 0) {
                summaryContainer.innerHTML = '<p style="color: #666;">ÈÅ∏Êäû„Åó„ÅüÊó•‰ªò„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                document.getElementById('sessionsDetailContainer').style.display = 'none';
                return;
            }
            
            summaryContainer.innerHTML = `
                <div class="summary-stats">
                    <div class="summary-item">
                        <div class="summary-number">${summary.sessionCount}</div>
                        <div class="summary-label">„Çª„ÉÉ„Ç∑„Éß„É≥Êï∞</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number">${summary.totalDuration}ÂàÜ</div>
                        <div class="summary-label">Á∑è‰ΩøÁî®ÊôÇÈñì</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number">${summary.applicationCount}</div>
                        <div class="summary-label">„Ç¢„Éó„É™Êï∞</div>
                    </div>
                </div>
                
                <h4>‰ΩøÁî®ÊôÇÈñì„ÅÆÂ§ö„ÅÑ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥</h4>
                <div>
                    ${dailyUsage.map(usage => `
                        <div style="margin: 8px 0; padding: 12px; background-color: ${getCategoryColor(usage.category)}; border-radius: 6px; cursor: pointer;" 
                             onclick="showApplicationSessions('${usage.application}')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong class="app-clickable">${usage.application}</strong> - ${usage.content}
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                        <span class="category-tag ${getCategoryClass(usage.category)}">${usage.category}</span>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: #4CAF50;">${usage.totalDuration}ÂàÜ</div>
                                    <div style="font-size: 12px; color: #666;">${usage.sessionCount}„Çª„ÉÉ„Ç∑„Éß„É≥</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('sessionsDetailContainer').style.display = 'block';
            setupFilters();
        }
        
        function setupFilters() {
            const categories = [...new Set(allSessions.map(s => s.category))];
            const applications = [...new Set(allSessions.map(s => s.application))];
            
            const filterContainer = document.getElementById('filterButtons');
            filterContainer.innerHTML = `
                <button class="filter-btn active" onclick="filterSessions('all')">„Åô„Åπ„Å¶</button>
                ${categories.map(cat => 
                    `<button class="filter-btn" onclick="filterSessions('category', '${cat}')">${cat}</button>`
                ).join('')}
            `;
        }
        
        function filterSessions(type, value) {
            // „Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            let filteredSessions = allSessions;
            
            if (type === 'category') {
                filteredSessions = allSessions.filter(s => s.category === value);
            }
            
            displaySessionsTable(filteredSessions);
        }
        
        function displaySessionsTable(sessions) {
            const tbody = document.getElementById('sessionsTableBody');
            
            if (sessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>';
                return;
            }
            
            tbody.innerHTML = sessions.map(session => `
                <tr>
                    <td class="session-time">
                        ${formatTimeShort(new Date(session.startTime))} - ${formatTimeShort(new Date(session.endTime))}
                    </td>
                    <td>
                        <span class="app-clickable" onclick="showApplicationSessions('${session.application}')">
                            ${session.application}
                        </span>
                    </td>
                    <td>${session.content}</td>
                    <td>
                        <span class="category-tag ${getCategoryClass(session.category)}">${session.category}</span>
                    </td>
                    <td>
                        <span class="duration-badge">${formatDuration(session.duration)}</span>
                    </td>
                    <td class="window-title" title="${session.windowTitle}">${session.windowTitle}</td>
                </tr>
            `).join('');
        }
        
        async function showApplicationSessions(application) {
            try {
                const appSessions = await ipcRenderer.invoke('get-application-sessions', currentDate, application);
                currentApplication = application;
                currentView = 'application';
                
                displaySessionsTable(appSessions);
                document.getElementById('backToOverview').style.display = 'block';
                
                // „Éï„Ç£„É´„Çø„Éº„ÇíÈùûË°®Á§∫
                document.querySelector('.filter-section').style.display = 'none';
                
            } catch (error) {
                console.error('„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Âà•„Çª„ÉÉ„Ç∑„Éß„É≥ÂèñÂæó„Ç®„É©„Éº:', error);
            }
        }
        
        function showOverview() {
            currentView = 'overview';
            currentApplication = null;
            
            displaySessionsTable(allSessions);
            document.getElementById('backToOverview').style.display = 'none';
            document.querySelector('.filter-section').style.display = 'block';
            
            // „Éï„Ç£„É´„Çø„Éº„Çí„É™„Çª„ÉÉ„Éà
            setupFilters();
        }

        // ÂàùÊúüÂåñ
        async function initializePage() {
            try {
                const availableDates = await ipcRenderer.invoke('get-available-dates');
                const quickSelect = document.getElementById('quickDateSelect');
                
                // Âà©Áî®ÂèØËÉΩ„Å™Êó•‰ªò„Çí„ÇØ„Ç§„ÉÉ„ÇØÈÅ∏Êäû„Å´ËøΩÂä†
                if (availableDates.length > 0) {
                    availableDates.slice(0, 10).forEach(date => {
                        const option = document.createElement('option');
                        option.value = date;
                        option.textContent = new Date(date).toLocaleDateString('ja-JP');
                        quickSelect.appendChild(option);
                    });
                }
                
                // ‰ªäÊó•„ÅÆÊó•‰ªò„Çí„Éá„Éï„Ç©„É´„Éà„Å´Ë®≠ÂÆö
                const today = formatLocalDate(new Date());
                document.getElementById('dateSelect').value = today;
                
            } catch (error) {
                console.error('ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            }
            
            refreshStats();
        }

        // CSV„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊ©üËÉΩ
        async function exportToCSV() {
            const startDateInput = document.getElementById('exportStartDate');
            const endDateInput = document.getElementById('exportEndDate');
            const exportButton = document.getElementById('exportButton');
            const progressDiv = document.getElementById('exportProgress');
            const progressBar = document.getElementById('progressBar');
            const resultDiv = document.getElementById('exportResult');

            // ÂÖ•ÂäõÂÄ§Ê§úË®º
            if (!startDateInput.value || !endDateInput.value) {
                showExportResult('„Ç®„É©„Éº: ÈñãÂßãÊó•„Å®ÁµÇ‰∫ÜÊó•„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);

            if (startDate > endDate) {
                showExportResult('„Ç®„É©„Éº: ÈñãÂßãÊó•„ÅØÁµÇ‰∫ÜÊó•„Çà„ÇäÂâç„ÅÆÊó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            try {
                // UIÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                exportButton.disabled = true;
                exportButton.textContent = 'Âá¶ÁêÜ‰∏≠...';
                progressDiv.style.display = 'block';
                resultDiv.style.display = 'none';

                // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÇíÈÄ≤Ë°å
                updateProgress(25);

                // CSV„Éá„Éº„Çø„ÇíÂèñÂæó
                const csvResult = await ipcRenderer.invoke('export-csv', startDateInput.value, endDateInput.value);
                updateProgress(75);

                if (!csvResult.success) {
                    throw new Error(csvResult.error || '‰∏çÊòé„Å™„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                }

                // „Éï„Ç°„Ç§„É´‰øùÂ≠ò„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
                const fileName = `usage-statistics-${startDateInput.value}-to-${endDateInput.value}.csv`;
                const saveResult = await ipcRenderer.invoke('save-csv-file', csvResult.data, fileName);
                updateProgress(100);

                if (saveResult.success) {
                    if (saveResult.canceled) {
                        showExportResult('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åå„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åæ„Åó„Åü', 'info');
                    } else {
                        showExportResult(`CSV„Éï„Ç°„Ç§„É´„ÅåÊ≠£Â∏∏„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü: ${saveResult.filePath}`, 'success');
                    }
                } else {
                    throw new Error(saveResult.error || '„Éï„Ç°„Ç§„É´‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

            } catch (error) {
                console.error('CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç®„É©„Éº:', error);
                showExportResult(`„Ç®„É©„Éº: ${error.message}`, 'error');
            } finally {
                // UIÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                exportButton.disabled = false;
                exportButton.textContent = 'üìã CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà';
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 2000);
            }
        }

        function updateProgress(percentage) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
        }

        function showExportResult(message, type) {
            const resultDiv = document.getElementById('exportResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = message;
            
            // „Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®
            resultDiv.className = '';
            if (type === 'success') {
                resultDiv.style.backgroundColor = '#d4edda';
                resultDiv.style.borderColor = '#c3e6cb';
                resultDiv.style.color = '#155724';
            } else if (type === 'error') {
                resultDiv.style.backgroundColor = '#f8d7da';
                resultDiv.style.borderColor = '#f5c6cb';
                resultDiv.style.color = '#721c24';
            } else if (type === 'info') {
                resultDiv.style.backgroundColor = '#d1ecf1';
                resultDiv.style.borderColor = '#bee5eb';
                resultDiv.style.color = '#0c5460';
            }
        }

        // ÂàùÊúüÂåñÊôÇ„Å´„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊó•‰ªò„ÇíË®≠ÂÆö
        function initializeExportDates() {
            const today = formatLocalDate(new Date());
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const weekAgoStr = formatLocalDate(oneWeekAgo);

            document.getElementById('exportStartDate').value = weekAgoStr;
            document.getElementById('exportEndDate').value = today;
        }

        // ÂàùÊúü„Éá„Éº„Çø„Çí„É™„ÇØ„Ç®„Çπ„Éà
        window.addEventListener('DOMContentLoaded', () => {
            initializePage();
            initializeExportDates();
        });
    </script>
</body>
</html>